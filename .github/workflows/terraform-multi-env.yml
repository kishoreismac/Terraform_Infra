name: Multi-Environment Terraform Deployment

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - test
          - prod

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  TF_VERSION: 1.6.6
  ARM_CLIENT_ID: "${{ secrets.CLIENT_ID }}"
  ARM_SUBSCRIPTION_ID: "${{ secrets.SUBSCRIPTION_ID }}"
  ARM_TENANT_ID: "${{ secrets.TENENT_ID }}"

jobs:
  # Security scanning for Pull Requests only
  security-scan:
    name: Security Scan
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      id-token: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login using OIDC
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.CLIENT_ID }}
          tenant-id: ${{ secrets.TENENT_ID }}
          subscription-id: ${{ secrets.SUBSCRIPTION_ID }}

      - name: Set Terraform Environment Variables
        run: |
          echo "ARM_CLIENT_ID=${{ secrets.CLIENT_ID }}" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=${{ secrets.SUBSCRIPTION_ID }}" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=${{ secrets.TENENT_ID }}" >> $GITHUB_ENV
          echo "ARM_USE_OIDC=true" >> $GITHUB_ENV

      - name: Install Gitleaks
        run: |
          curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.18.2/gitleaks_8.18.2_linux_x64.tar.gz -o gitleaks.tar.gz
          tar -xzf gitleaks.tar.gz
          sudo mv gitleaks /usr/local/bin/

      - name: Run Gitleaks
        run: |
          gitleaks detect --source . --no-git --redact --exit-code 0

      - name: Install tfsec
        run: |
          TFSEC_VERSION="v1.28.4"
          curl -sSL https://github.com/aquasecurity/tfsec/releases/download/${TFSEC_VERSION}/tfsec-linux-amd64 -o tfsec
          chmod +x tfsec
          sudo mv tfsec /usr/local/bin/

      - name: Run tfsec
        run: tfsec . --format default

      - name: Install Checkov
        run: pip install checkov

      - name: Run Checkov
        continue-on-error: true
        run: checkov -d . --framework terraform --compact --quiet

      - name: Security Scan Summary
        run: |
          echo "# Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Secret scanning completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Terraform security checks completed" >> $GITHUB_STEP_SUMMARY
          echo "âœ… IaC compliance checks completed" >> $GITHUB_STEP_SUMMARY

  determine-environments:
    name: Determine Deployment Environments
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.set-envs.outputs.environments }}
      should_apply: ${{ steps.set-envs.outputs.should_apply }}
    
    steps:
      - name: Determine Environments to Deploy
        id: set-envs
        run: |
          # For Pull Requests: Plan only, no apply
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "should_apply=false" >> $GITHUB_OUTPUT
            if [ "${{ github.base_ref }}" == "main" ]; then
              echo "environments=[\"prod\"]" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ PR to main: Planning for PROD environment only"
            elif [ "${{ github.base_ref }}" == "develop" ]; then
              echo "environments=[\"dev\",\"test\"]" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ PR to develop: Planning for DEV and TEST environments"
            else
              echo "environments=[\"dev\"]" >> $GITHUB_OUTPUT
            fi
          # For Push to develop: Plan and Apply to dev and test
          elif [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref_name }}" == "develop" ]; then
            echo "should_apply=true" >> $GITHUB_OUTPUT
            echo "environments=[\"dev\",\"test\"]" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Push to develop: Deploying to DEV and TEST environments"
          # For Push to main: Plan and Apply to prod
          elif [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref_name }}" == "main" ]; then
            echo "should_apply=true" >> $GITHUB_OUTPUT
            echo "environments=[\"prod\"]" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Push to main: Deploying to PROD environment"
          # For manual dispatch: Plan and Apply to selected environment
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_apply=true" >> $GITHUB_OUTPUT
            echo "environments=[\"${{ github.event.inputs.environment }}\"]" >> $GITHUB_OUTPUT
          else
            echo "should_apply=false" >> $GITHUB_OUTPUT
            echo "environments=[\"dev\"]" >> $GITHUB_OUTPUT
          fi

  terraform-plan:
    name: 'Terraform Plan - ${{ matrix.environment }}'
    runs-on: ubuntu-latest
    needs: determine-environments
    strategy:
      matrix:
        environment: ${{ fromJson(needs.determine-environments.outputs.environments) }}
      fail-fast: false
    
    env:
      ARM_SKIP_PROVIDER_REGISTRATION: true
      WORKING_DIR: ./envs/${{ matrix.environment }}
    
    outputs:
      tfplanExitCode-dev: ${{ matrix.environment == 'dev' && steps.tf-plan.outputs.exitcode || '' }}
      tfplanExitCode-test: ${{ matrix.environment == 'test' && steps.tf-plan.outputs.exitcode || '' }}
      tfplanExitCode-prod: ${{ matrix.environment == 'prod' && steps.tf-plan.outputs.exitcode || '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login using OIDC
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.CLIENT_ID }}
          tenant-id: ${{ secrets.TENENT_ID }}
          subscription-id: ${{ secrets.SUBSCRIPTION_ID }}

      - name: Set Terraform Environment Variables
        run: |
          echo "ARM_CLIENT_ID=${{ secrets.CLIENT_ID }}" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=${{ secrets.SUBSCRIPTION_ID }}" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=${{ secrets.TENENT_ID }}" >> $GITHUB_ENV
          echo "ARM_USE_OIDC=true" >> $GITHUB_ENV

      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform init

      - name: Terraform Format Check
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform fmt -check
        continue-on-error: true

      - name: Terraform Validate
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform validate

      - name: Terraform Plan
        id: tf-plan
        working-directory: ${{ env.WORKING_DIR }}
        shell: bash
        run: |
          set +e
          terraform plan -detailed-exitcode -no-color -out=tfplan
          exitcode=$?
          set -e

          echo "exitcode=$exitcode" >> "$GITHUB_OUTPUT"

          if [ "$exitcode" -eq 1 ]; then
            echo "Terraform plan failed for ${{ matrix.environment }}"
            exit 1
          fi

      - name: Publish Terraform Plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ matrix.environment }}
          path: ${{ env.WORKING_DIR }}/tfplan
          retention-days: 5

      - name: Create Plan Summary
        id: tf-plan-string
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          TERRAFORM_PLAN=$(terraform show -no-color tfplan)

          delimiter="$(openssl rand -hex 8)"
          echo "summary<<${delimiter}" >> $GITHUB_OUTPUT
          echo "## Terraform Plan Output - ${{ matrix.environment }} Environment" >> $GITHUB_OUTPUT
          echo "<details><summary>Click to expand</summary>" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo '```terraform' >> $GITHUB_OUTPUT
          echo "$TERRAFORM_PLAN" >> $GITHUB_OUTPUT
          echo '```' >> $GITHUB_OUTPUT
          echo "</details>" >> $GITHUB_OUTPUT
          echo "${delimiter}" >> $GITHUB_OUTPUT

      - name: Publish Plan to Task Summary
        env:
          SUMMARY: ${{ steps.tf-plan-string.outputs.summary }}
        run: echo "$SUMMARY" >> $GITHUB_STEP_SUMMARY

      - name: Push Plan to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          SUMMARY: "${{ steps.tf-plan-string.outputs.summary }}"
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = `${process.env.SUMMARY}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            })

  terraform-apply-dev:
    name: 'Terraform Apply - dev'
    if: |
      needs.determine-environments.outputs.should_apply == 'true' &&
      github.ref_name == 'develop' &&
      contains(fromJson(needs.determine-environments.outputs.environments), 'dev')
    runs-on: ubuntu-latest
    needs: [determine-environments, terraform-plan]
    environment: dev
    
    env:
      WORKING_DIR: ./envs/dev

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login using OIDC
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.CLIENT_ID }}
          tenant-id: ${{ secrets.TENENT_ID }}
          subscription-id: ${{ secrets.SUBSCRIPTION_ID }}

      - name: Set Terraform Environment Variables
        run: |
          echo "ARM_USE_OIDC=true" >> $GITHUB_ENV
          echo "ARM_CLIENT_ID=${{ secrets.CLIENT_ID }}" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=${{ secrets.TENENT_ID }}" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=${{ secrets.SUBSCRIPTION_ID }}" >> $GITHUB_ENV

      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform init

      - name: Download Terraform Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-dev
          path: ${{ env.WORKING_DIR }}

      - name: Terraform Apply
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform apply -auto-approve tfplan

      - name: Deployment Summary
        run: |
          echo "# Deployment Complete - dev Environment" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Infrastructure deployed successfully to dev environment" >> $GITHUB_STEP_SUMMARY

  terraform-apply-test:
    name: 'Terraform Apply - test'
    if: |
      needs.determine-environments.outputs.should_apply == 'true' &&
      github.ref_name == 'develop' &&
      contains(fromJson(needs.determine-environments.outputs.environments), 'test')
    runs-on: ubuntu-latest
    needs: [determine-environments, terraform-plan, terraform-apply-dev]
    environment: test
    
    env:
      WORKING_DIR: ./envs/test

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login using OIDC
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.CLIENT_ID }}
          tenant-id: ${{ secrets.TENENT_ID }}
          subscription-id: ${{ secrets.SUBSCRIPTION_ID }}

      - name: Set Terraform Environment Variables
        run: |
          echo "ARM_USE_OIDC=true" >> $GITHUB_ENV
          echo "ARM_CLIENT_ID=${{ secrets.CLIENT_ID }}" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=${{ secrets.TENENT_ID }}" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=${{ secrets.SUBSCRIPTION_ID }}" >> $GITHUB_ENV

      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform init

      - name: Download Terraform Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-test
          path: ${{ env.WORKING_DIR }}

      - name: Terraform Apply
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform apply -auto-approve tfplan

      - name: Deployment Summary
        run: |
          echo "# Deployment Complete - test Environment" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Infrastructure deployed successfully to test environment" >> $GITHUB_STEP_SUMMARY

  terraform-apply-prod:
    name: 'Terraform Apply - prod'
    if: |
      needs.determine-environments.outputs.should_apply == 'true' &&
      github.ref_name == 'main' &&
      contains(fromJson(needs.determine-environments.outputs.environments), 'prod')
    runs-on: ubuntu-latest
    needs: [determine-environments, terraform-plan]
    environment: production
    
    env:
      WORKING_DIR: ./envs/prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Azure Login using OIDC
        uses: azure/login@v1
        with:
          client-id: ${{ secrets.CLIENT_ID }}
          tenant-id: ${{ secrets.TENENT_ID }}
          subscription-id: ${{ secrets.SUBSCRIPTION_ID }}

      - name: Set Terraform Environment Variables
        run: |
          echo "ARM_USE_OIDC=true" >> $GITHUB_ENV
          echo "ARM_CLIENT_ID=${{ secrets.CLIENT_ID }}" >> $GITHUB_ENV
          echo "ARM_TENANT_ID=${{ secrets.TENENT_ID }}" >> $GITHUB_ENV
          echo "ARM_SUBSCRIPTION_ID=${{ secrets.SUBSCRIPTION_ID }}" >> $GITHUB_ENV

      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform init

      - name: Download Terraform Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-prod
          path: ${{ env.WORKING_DIR }}

      - name: Terraform Apply
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform apply -auto-approve tfplan

      - name: Deployment Summary
        run: |
          echo "# Deployment Complete - prod Environment" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Infrastructure deployed successfully to production environment" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ Production deployment completed!" >> $GITHUB_STEP_SUMMARY
